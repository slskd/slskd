name: Mirror Repository

on:
  push:
    branches:
      - '**'  # Trigger on push to any branch
  delete:
    branches:
      - '**'  # Trigger when branches are deleted
  workflow_dispatch:

concurrency:
  group: mirror-sync
  cancel-in-progress: false

jobs:
  mirror:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target:
          - name: GitLab
            host: gitlab.com
            repo: git@gitlab.com:slskd/slskd.git
          - name: Codeberg
            host: codeberg.org
            repo: git@codeberg.org:slskd/slskd.git
      fail-fast: false  # Continue with other mirrors even if one fails

    steps:
    - name: Configure SSH
      env:
        SSH_KEY: ${{ secrets.GIT_MIRROR_SSH_KEY }}
      run: |
        if [ -z "$SSH_KEY" ]; then
          echo "âš ï¸ SSH key not configured. Skipping mirror sync."
          echo "Please set GIT_MIRROR_SSH_KEY secret to enable mirroring."
          exit 1
        fi

        # Set up SSH key
        mkdir -p ~/.ssh
        echo "$SSH_KEY" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519

        # Start SSH agent and add key
        eval "$(ssh-agent -s)"
        ssh-add ~/.ssh/id_ed25519

        # Add known host to avoid SSH prompts
        ssh-keyscan ${{ matrix.target.host }} >> ~/.ssh/known_hosts

        # Configure Git
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

    - name: Mirror to ${{ matrix.target.name }}
      run: |
        echo "ðŸ”„ Mirroring repository to ${{ matrix.target.name }}..."
        
        # Clone the GitHub repository as a mirror (bare repo with all refs)
        git clone --mirror https://github.com/${{ github.repository }}.git mirror-repo
        cd mirror-repo
        
        # Set the push URL to the target repository
        git remote set-url --push origin ${{ matrix.target.repo }}
        
        # Push everything to the mirror (handles all branches, tags, and deletions)
        git push --mirror
        
        echo "âœ… Successfully mirrored to ${{ matrix.target.name }}"