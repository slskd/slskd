name: Mirror Repository

on:
  push:
    branches:
      - '**'  # Trigger on push to any branch
  delete:
    branches:
      - '**'  # Trigger when branches are deleted

jobs:
  mirror:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target:
          - name: GitLab
            host: gitlab.com
            repo: git@gitlab.com:slskd/slskd.git
          - name: Codeberg
            host: codeberg.org
            repo: git@codeberg.org:slskd/slskd.git
      fail-fast: false  # Continue with other mirrors even if one fails

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for proper mirroring
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Configure SSH
      env:
        SSH_KEY: ${{ secrets.GIT_MIRROR_SSH_KEY }}
      run: |
        if [ -z "$SSH_KEY" ]; then
          echo "‚ö†Ô∏è SSH key not configured. Skipping mirror sync."
          echo "Please set GIT_MIRROR_SSH_KEY secret to enable mirroring."
          exit 1
        fi

        # Set up SSH key
        mkdir -p ~/.ssh
        echo "$SSH_KEY" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519

        # Start SSH agent and add key
        eval "$(ssh-agent -s)"
        ssh-add ~/.ssh/id_ed25519

        # Add known host to avoid SSH prompts
        ssh-keyscan ${{ matrix.target.host }} >> ~/.ssh/known_hosts

        # Configure Git
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

    - name: Mirror to ${{ matrix.target.name }}
      if: github.event_name != 'delete'
      run: |
        echo "üîÑ Syncing to ${{ matrix.target.name }}..."
        # Add remote with SSH
        git remote add mirror ${{ matrix.target.repo }}

        # Push all branches and tags
        git push mirror --all --force
        git push mirror --tags --force

        echo "‚úÖ Successfully synced to ${{ matrix.target.name }}"

    - name: Handle branch deletion on ${{ matrix.target.name }}
      if: github.event_name == 'delete' && github.event.ref_type == 'branch'
      run: |
        DELETED_BRANCH="${{ github.event.ref }}"
        echo "üóëÔ∏è Branch '$DELETED_BRANCH' was deleted, syncing deletion to ${{ matrix.target.name }}..."

        # Delete branch from mirror
        git push ${{ matrix.target.repo }} --delete "$DELETED_BRANCH" || echo "Branch may not exist on ${{ matrix.target.name }}"